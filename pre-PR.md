# Pre-PR Checklist (EdgeInfer Inference & Test Harness)

## Current Snapshot (auto-generated)
- Feature flag real inference (`USE_REAL_MODEL`) present.
- Sidecar client service (`ModelInferenceService`) implemented.
- Metrics placeholder (`MotifsMetrics`) no-op.
- Test suite expanded (stub path, real path mock, inference service error cases) but RED due to harness issues.
- DB dependency (Fluent + Todo) still present; in tests now using in-memory DB but still building migrations.
- Legacy test harness artifacts (`LinuxMain.swift`, `XCTestManifests.swift`) still in tree while using `--enable-test-discovery` (conflict risk).
- Permissions on prior `.build` artifacts fixed; clean rebuild succeeded until test execution stage.

## Required Before PR (Must be Green)
- [ ] Green `swift test` (no fatalError, no unresolved DB attach errors).
- [ ] Remove `Tests/AppTests/LinuxMain.swift` and `Tests/AppTests/XCTestManifests.swift` OR stop using `--enable-test-discovery` (choose one path; recommended: delete files & keep discovery).
- [ ] Fix `InferenceServiceTests` request construction (remove `routes.makeRequest` usage).
- [ ] Ensure tests don't require Fluent if not asserting DB behavior (option: conditionally compile or remove Todo).
- [ ] Add fast-fail timeout for unreachable model host (already shorter connect=1s in test mode).
- [ ] Document test mode behavior (in this file or README section).

## Nice-To-Have (Optional for Initial PR)
- [ ] Add integration test hitting real sidecar (behind feature flag) via docker-compose overlay.
- [ ] Add latency assertion harness (capture duration < threshold for stub, > 0 for real) once metrics reinstated.
- [ ] Remove Todo / Fluent code if unused by product scope to shrink build.
- [ ] Add `scripts/test-docker.sh` (if not present) with cached volumes (reintroduce if previously removed).
- [ ] CI workflow referencing `scripts/test-docker.sh`.

## Rollback / Kill Switch (Status)
`ROLLBACK.md` exists (historical commit). Need to re-add to repo if missing.
- [ ] Confirm `ROLLBACK.md` present at root or `EdgeInfer/ROLLBACK.md` and referenced in PR description.

## PR Body Must Include
- Summary of feature flag & fallback path.
- Explicit kill-switch instructions (env var + sidecar stop method).
- Test matrix summary (stub path, real path mocked, error conditions).
- Follow-up items deferred (metrics, real integration test, DB code removal).

## Verification Commands (for reviewer)
```
swift test --enable-test-discovery -q
USE_REAL_MODEL=false swift run Run & curl -s localhost:8080/api/v1/analysis/motifs | jq .
USE_REAL_MODEL=true MODEL_BACKEND_URL=http://127.0.0.1:9999 swift run Run & sleep 1; curl -s localhost:8080/api/v1/analysis/motifs | jq .
```

## Decision Log
| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-08-30 | Removed EdgeInfer secondary executable from build | Avoid duplicate main & test conflicts |
| 2025-08-30 | In-memory DB for tests | Eliminate file permission flakiness |

## Next Actions (Ordered)
1. Delete LinuxMain + manifests; rerun tests.
2. Patch `InferenceServiceTests` to build a Request via `Request(application:on:)`.
3. Re-run tests; stabilize green.
4. (Optional) Strip Todo + migrations if not needed.
5. Re-add / confirm `ROLLBACK.md` in repo.
6. Update PR body referencing this checklist; mark done items.

---
Generated by automation; edit freely before submitting PR.
