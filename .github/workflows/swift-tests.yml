name: Swift CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      - name: Init submodules that are actual gitlinks
        shell: bash
        run: |
          set -euo pipefail
          gitlinks="$(git ls-files --stage | awk '$1=="160000"{print $4}')"
          if [ -n "$gitlinks" ]; then
            echo "Gitlinks detected:"
            printf "%s\n" "$gitlinks"
            for sm in $gitlinks; do
              echo "Initializing submodule $sm"
              git submodule sync -- "$sm"
              git submodule update --init -- "$sm"
            done
          else
            echo "No gitlinks present in this commit; skipping submodule init."
          fi

      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9"
          skip-gpg: true

      - name: Install system deps (Vapor common)
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev libssl-dev zlib1g-dev libcurl4-openssl-dev

      - name: Cache SPM build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-

      - name: Resolve packages
        run: swift package resolve

      - name: Build & Test
        run: |
          swift --version
          swift build -c release --disable-sandbox
          swift test --parallel --disable-sandbox
